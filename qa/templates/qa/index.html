<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Geek QA Home</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"
      crossorigin="anonymous"
    />

    <style>
      .row {
        padding: 10px;
        border: 1px black solid;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row my-3">
        <h1>Geek QA</h1>
      </div>

      <div class="row my-3">
        <form action="/create_error" method="POST">
          {% csrf_token %}
          <!-- Notes -->
          <div class="form-group">
            <label for="notesInput">Notes</label>
            <textarea
              class="form-control"
              id="notesInput"
              name="notes"
              placeholder="Please provide a brief description of the error"
            ></textarea>
          </div>

          <!-- FP# -->
          <div class="form-group">
            <label for="fpInput">FP#</label>
            <input
              type="text"
              class="form-control"
              id="fpInput"
              name="footprints_number"
              placeholder="12345"
            />
          </div>

          <!-- Found Date -->
          <div class="form-group">
            <label for="dateFoundInput">Date Found</label>
            <input
              type="date"
              class="form-control"
              id="dateFoundInput"
              name="found_date"
            />
          </div>

          <!-- Committed Date -->
          <div class="form-group">
            <label for="dateCommittedInput">Date Committed</label>
            <input
              type="date"
              class="form-control"
              id="dateCommittedInput"
              name="committed_date"
            />
          </div>

          <!-- Error Type -->
          <div class="form-group">
            <label for="errorTypeInput">Error Type</label>
            <select
              class="form-control"
              id="errorTypeInput"
              name="error_type_id"
            >
              {% for error_type in available_error_types %}
              <option value="{{ error_type.id }}">{{ error_type.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Employee -->
          <div class="form-group">
            <label for="employeeInput">Employee</label>
            <select class="form-control" id="employeeInput" name="employee_id">
              {% for employee in available_employees %}
              <option value="{{ employee.id }}">{{ employee.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Coordinator -->
          <div class="form-group">
            <label for="coordinatorInput">Coordinator</label>
            <select
              class="form-control"
              id="coordinatorInput"
              name="coordinator_id"
            >
              {% for coordinator in available_coordinators %}
              <option value="{{ coordinator.id }}">
                {{ coordinator.name }}
              </option>
              {% endfor %}
            </select>
          </div>

          <!-- Tags -->
          <div class="form-group">
            <label for="tagInput">Tags</label>
            <select
              multiple
              class="form-control"
              id="tagInput"
              name="tag_ids"
              aria-describedby="tagHelp"
            >
              {% for tag in available_tags %}
              <option value="{{ tag.id }}">{{ tag.name }}</option>
              {% endfor %}
            </select>
            <small id="tagHelp" class="form-text text-muted">
              Hold CTRL to select multiple tags
            </small>
          </div>

          <br />

          <button type="submit" class="btn btn-primary">Add</button>
        </form>
      </div>

      <div class="row my-3">
        <div class="col-lg-6 my-3">
          <canvas id="pie-chart"></canvas>
        </div>
        <div class="col-lg-6 my-3">
          <canvas id="line-chart"></canvas>
        </div>
      </div>

      <div class="row my-3">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th scope="col">Geek Name</th>
              <th scope="col">Error Type</th>
              <th scope="col">Commit Date</th>
              <th scope="col">Date Found</th>
            </tr>
          </thead>
          <tbody>
            {% for e in errors %}
            <tr data-id="{{ e.id }}">
              <td>{{ e.employees }}</td>
              <td>{{ e.type.name }}</td>
              <td>{{ e.committed_date }}</td>
              <td>{{ e.found_date }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>

    <!-- POPULATE TABLE -->
    <script>
      document.querySelectorAll("tr").forEach((row) => {
        row.addEventListener("click", () => {
          const error_id = row.dataset.id;

          //facilitates HTTP requests
          fetch(`/error/${error_id}`)
            .then((response) => response.json())
            .then((data) => alert(data.notes));
        });
      });
    </script>

    <!-- PIE CHART -->
    <script>

      function getRandomColor() {
        return `#${Math.floor(Math.random()*16777215).toString(16)}`
      }

      backgroundColors = ['#AA0000', '#0000AA', '#00AA00', '#00AA88', '#A04AA0']

      const errorType = {{ error_names|safe }}
      const amountPerError = {{ error_counts|safe }}

      const loopToThisNumber = errorType.length - backgroundColors.length;

      for(let i = 0; i < loopToThisNumber; i += 1) {
        backgroundColors.push(getRandomColor())
      };

      var config = {
        type: 'pie',
        data: {
          datasets: [{
            data: amountPerError,
            backgroundColor: backgroundColors,
            label: 'Type of Error Comparison'
          }],
          labels: errorType
        },
        options: {
          responsive: true
        }
      };

      var ctx = document.getElementById('pie-chart').getContext('2d');
      window.myPie1 = new Chart(ctx, config);
    </script>

    <!-- LINE CHART -->
    <script>

      const days = {{ days|safe }}
      const error_counts_by_day = {{ error_counts_by_day|safe }}

      var config = {
        type: "line",
        data: {
          datasets: [
            {
              data: error_counts_by_day,
              backgroundColor: backgroundColors,
              label: "Error Count by Week",
              fill: false,
              borderColor: "#000000",
            },
          ],
          labels: days,
        },
        options: {
          responsive: true,
          hover: {
            mode: 'label'
          },
          scales: {
            yAxes: [{
              display: true,
              ticks: {
                beginAtZero: true
              }
            }]
          },

        }
      };

      var ctx = document.getElementById("line-chart").getContext("2d");
      window.myPie2 = new Chart(ctx, config);
    </script>
  </body>
</html>
